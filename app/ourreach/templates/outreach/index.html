{% extends "base.html" %} {% block title %}Our Reach - Ardur Healthcare{%
endblock %} {% block content %}
<main class="min-h-screen bg-white">
    <!-- Header Section -->
    <section
        class="relative bg-gradient-to-br from-brand-primary via-brand-secondary to-brand-dark overflow-hidden"
    >
        <div class="absolute inset-0 bg-black bg-opacity-20"></div>

        <!-- Decorative Elements -->
        <div
            class="absolute top-10 left-10 w-20 h-20 bg-white bg-opacity-10 rounded-full blur-xl"
        ></div>
        <div
            class="absolute bottom-20 right-20 w-32 h-32 bg-white bg-opacity-5 rounded-full blur-2xl"
        ></div>
        <div
            class="absolute top-1/2 left-1/4 w-16 h-16 bg-white bg-opacity-5 rounded-full blur-lg"
        ></div>

        <div class="relative z-10 container mx-auto px-6 py-20 md:py-28">
            <div class="max-w-4xl mx-auto text-center">
                <div class="mb-8" data-aos="fade-down">
                    <div
                        class="inline-flex items-center px-4 py-2 bg-black/30 backdrop-blur-sm rounded-full mb-6"
                    >
                        <i class="ri-map-pin-line text-brand-accent mr-2"></i>
                        <span class="text-brand-accent font-light"
                            >Our Reach</span
                        >
                    </div>
                    <h1
                        class="text-4xl md:text-6xl font-thin font-montserrat text-white mb-4 drop-shadow-lg"
                    >
                        State-Specific
                        <span class="text-brand-accent drop-shadow-lg"
                            >Medical Billing Services</span
                        >
                    </h1>
                    <p
                        class="text-lg md:text-xl text-white mb-8 leading-relaxed max-w-4xl mx-auto drop-shadow-md"
                    >
                        Explore Ardur Healthcare's state-specific medical
                        billing services across the U.S. Click your state to
                        discover our local expertise and tailored RCM solutions.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Map Section -->
    <section class="py-16 md:py-24 bg-white">
        <div class="max-w-7xl mx-auto px-6">
            <div class="text-center mb-16">
                <h2
                    class="text-3xl md:text-4xl font-light font-montserrat text-brand-dark mb-4"
                    data-aos="fade-up"
                >
                    Interactive U.S. Billing Map
                </h2>
                <p
                    class="text-lg text-gray-700 max-w-4xl mx-auto"
                    data-aos="fade-up"
                    data-aos-delay="200"
                >
                    Select your state to explore state-specific medical billing
                    services from Ardur Healthcare.
                </p>
            </div>

            <div
                class="bg-white rounded-xl shadow-lg overflow-hidden"
                data-aos="fade-up"
            >
                <div class="">
                    <div class="map-container-fixed h-auto" id="map-container">
                        <div
                            id="map-loading"
                            class="map-loading"
                            style="display: none"
                        >
                            <div class="loading-spinner">
                                <div class="spinner"></div>
                                <p class="mt-3 text-gray-600 text-sm">
                                    Loading map...
                                </p>
                            </div>
                        </div>

                        <div id="usa-map" class="usa-map-container">
                            <div class="map-fallback">
                                <p class="text-gray-500">
                                    Loading interactive map...
                                </p>
                                <button
                                    onclick="testMapLoad()"
                                    class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors"
                                >
                                    Test Map Load
                                </button>
                            </div>
                            <!-- Fallback image for when fetch fails -->
                            <img
                                id="usa-map-fallback"
                                src="{{ url_for('static', filename='maps/MapChart_Map.svg') }}"
                                alt="USA Map"
                                style="
                                    display: none;
                                    width: 100%;
                                    height: 100%;
                                    object-fit: contain;
                                "
                                onload="handleFallbackImageLoad()"
                                onerror="handleFallbackImageError()"
                            />
                        </div>

                        <div id="map-tooltip" class="map-tooltip"></div>
                    </div>

                    <div class="p-6">
                        <div class="flex justify-center">
                            <div class="bg-brand-light rounded-lg px-6 py-3">
                                <div class="flex items-center gap-6 text-sm">
                                    <div class="flex items-center gap-2">
                                        <div
                                            class="w-4 h-4 bg-brand-primary rounded-full"
                                        ></div>
                                        <span class="text-gray-700"
                                            >Available Services</span
                                        >
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div
                                            class="w-4 h-4 bg-brand-accent rounded-full"
                                        ></div>
                                        <span class="text-gray-700"
                                            >Featured States</span
                                        >
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Statistics Section -->
    <section class="py-16 md:py-24 bg-brand-light">
        <div class="max-w-7xl mx-auto px-6">
            <div class="text-center mb-16">
                <h2
                    class="text-3xl md:text-4xl font-light font-montserrat text-brand-dark mb-4"
                    data-aos="fade-up"
                >
                    Our Nationwide Reach at a Glance
                </h2>
                <p
                    class="text-lg text-gray-700 max-w-4xl mx-auto"
                    data-aos="fade-up"
                    data-aos-delay="200"
                >
                    From coast to coast, we provide state-specific medical
                    billing services with consistent quality and local insight.
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <div
                    class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 text-center"
                    data-aos="fade-up"
                    data-aos-delay="100"
                >
                    <div
                        class="flex justify-center items-center h-16 w-16 bg-brand-secondary rounded-full mx-auto mb-6"
                    >
                        <i
                            class="ri-government-line text-2xl text-brand-primary"
                        ></i>
                    </div>
                    <h3
                        class="text-3xl font-light font-montserrat text-brand-dark mb-2"
                    >
                        50
                    </h3>
                    <p class="text-gray-700">Active States</p>
                </div>

                <div
                    class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 text-center"
                    data-aos="fade-up"
                    data-aos-delay="200"
                >
                    <div
                        class="flex justify-center items-center h-16 w-16 bg-brand-secondary rounded-full mx-auto mb-6"
                    >
                        <i class="ri-time-line text-2xl text-brand-primary"></i>
                    </div>
                    <h3
                        class="text-3xl font-light font-montserrat text-brand-dark mb-2"
                    >
                        4
                    </h3>
                    <p class="text-gray-700">Time Zones</p>
                </div>

                <div
                    class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 text-center"
                    data-aos="fade-up"
                    data-aos-delay="300"
                >
                    <div
                        class="flex justify-center items-center h-16 w-16 bg-brand-secondary rounded-full mx-auto mb-6"
                    >
                        <i
                            class="ri-hospital-line text-2xl text-brand-primary"
                        ></i>
                    </div>
                    <h3
                        class="text-3xl font-light font-montserrat text-brand-dark mb-2"
                    >
                        500+
                    </h3>
                    <p class="text-gray-700">Healthcare Providers</p>
                </div>

                <div
                    class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 text-center"
                    data-aos="fade-up"
                    data-aos-delay="400"
                >
                    <div
                        class="flex justify-center items-center h-16 w-16 bg-brand-secondary rounded-full mx-auto mb-6"
                    >
                        <i
                            class="ri-award-line text-2xl text-brand-primary"
                        ></i>
                    </div>
                    <h3
                        class="text-3xl font-light font-montserrat text-brand-dark mb-2"
                    >
                        15+
                    </h3>
                    <p class="text-gray-700">Years Experience</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section class="py-16 md:py-24 bg-white">
        <div class="max-w-7xl mx-auto px-6">
            <div class="text-center mb-16">
                <h2
                    class="text-3xl md:text-4xl font-light font-montserrat text-brand-dark mb-4"
                    data-aos="fade-up"
                >
                    Why Choose Our State-Specific Services?
                </h2>
                <p
                    class="text-lg text-gray-700 max-w-4xl mx-auto"
                    data-aos="fade-up"
                    data-aos-delay="200"
                >
                    Our state-specific billing approach ensures high-quality,
                    compliant medical billing across all U.S. states.
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div
                    class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300"
                    data-aos="fade-up"
                    data-aos-delay="100"
                >
                    <div
                        class="flex justify-center items-center h-16 w-16 bg-brand-secondary rounded-full mx-auto mb-6"
                    >
                        <i
                            class="ri-map-pin-line text-2xl text-brand-primary"
                        ></i>
                    </div>
                    <h3
                        class="text-lg font-light font-montserrat text-brand-dark mb-3 text-center"
                    >
                        Local Expertise
                    </h3>
                    <p class="text-gray-700 text-center">
                        In-depth understanding of state-specific billing
                        regulations and payer networks.
                    </p>
                </div>

                <div
                    class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300"
                    data-aos="fade-up"
                    data-aos-delay="200"
                >
                    <div
                        class="flex justify-center items-center h-16 w-16 bg-brand-secondary rounded-full mx-auto mb-6"
                    >
                        <i
                            class="ri-shield-check-line text-2xl text-brand-primary"
                        ></i>
                    </div>
                    <h3
                        class="text-lg font-light font-montserrat text-brand-dark mb-3 text-center"
                    >
                        Compliance First
                    </h3>
                    <p class="text-gray-700 text-center">
                        Full compliance with HIPAA and each state's regulatory
                        requirements.
                    </p>
                </div>

                <div
                    class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300"
                    data-aos="fade-up"
                    data-aos-delay="300"
                >
                    <div
                        class="flex justify-center items-center h-16 w-16 bg-brand-secondary rounded-full mx-auto mb-6"
                    >
                        <i
                            class="ri-customer-service-line text-2xl text-brand-primary"
                        ></i>
                    </div>
                    <h3
                        class="text-lg font-light font-montserrat text-brand-dark mb-3 text-center"
                    >
                        24/7 Support
                    </h3>
                    <p class="text-gray-700 text-center">
                        Dedicated account managers available across time zones
                        and regions.
                    </p>
                </div>

                <div
                    class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300"
                    data-aos="fade-up"
                    data-aos-delay="400"
                >
                    <div
                        class="flex justify-center items-center h-16 w-16 bg-brand-secondary rounded-full mx-auto mb-6"
                    >
                        <i
                            class="ri-check-line text-2xl text-brand-primary"
                        ></i>
                    </div>
                    <h3
                        class="text-lg font-light font-montserrat text-brand-dark mb-3 text-center"
                    >
                        All 50 States Covered
                    </h3>
                    <p class="text-gray-700 text-center">
                        Complete coverage across all U.S. states with local
                        expertise in each region.
                    </p>
                </div>

                <div
                    class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300"
                    data-aos="fade-up"
                    data-aos-delay="500"
                >
                    <div
                        class="flex justify-center items-center h-16 w-16 bg-brand-secondary rounded-full mx-auto mb-6"
                    >
                        <i
                            class="ri-map-2-line text-2xl text-brand-primary"
                        ></i>
                    </div>
                    <h3
                        class="text-lg font-light font-montserrat text-brand-dark mb-3 text-center"
                    >
                        Regional Payer Networks
                    </h3>
                    <p class="text-gray-700 text-center">
                        Deep knowledge of regional insurance networks and
                        billing requirements.
                    </p>
                </div>

                <div
                    class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300"
                    data-aos="fade-up"
                    data-aos-delay="600"
                >
                    <div
                        class="flex justify-center items-center h-16 w-16 bg-brand-secondary rounded-full mx-auto mb-6"
                    >
                        <i
                            class="ri-settings-line text-2xl text-brand-primary"
                        ></i>
                    </div>
                    <h3
                        class="text-lg font-light font-montserrat text-brand-dark mb-3 text-center"
                    >
                        Customized Solutions
                    </h3>
                    <p class="text-gray-700 text-center">
                        Tailored billing solutions that adapt to your state's
                        specific requirements and regulations.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Final CTA Section -->
    <section
        class="py-16 md:py-24 bg-brand-secondary text-center relative overflow-hidden"
    >
        <div class="absolute inset-0 bg-black/5"></div>
        <div class="relative max-w-4xl mx-auto px-6" data-aos="fade-up">
            <h2
                class="text-3xl md:text-4xl font-thin font-montserrat text-brand-dark mb-6"
            >
                Ready to Get Started?
            </h2>
            <p
                class="text-xl text-brand-dark/80 font-light mb-8 max-w-2xl mx-auto"
            >
                Contact us to learn how our state-specific medical billing
                services can boost your revenue across all U.S. time zones.
            </p>
            <a
                href="{{ url_for('contact.contact_form') }}"
                class="bg-brand-primary text-white font-montserrat font-light px-8 py-4 rounded-full hover:scale-105 hover:shadow-xl hover:bg-brand-dark transition duration-300 inline-block"
            >
                Get in Touch with Our Team
            </a>
        </div>
    </section>
</main>

<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
<link
    href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css"
    rel="stylesheet"
/>

<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
    // Initialize AOS
    AOS.init({
        duration: 800,
        once: true,
        offset: 100,
    });

    // State abbreviation to full name mapping
    const stateAbbreviationMap = {
        AL: "Alabama",
        AK: "Alaska",
        AZ: "Arizona",
        AR: "Arkansas",
        CA: "California",
        CO: "Colorado",
        CT: "Connecticut",
        DE: "Delaware",
        FL: "Florida",
        GA: "Georgia",
        HI: "Hawaii",
        ID: "Idaho",
        IL: "Illinois",
        IN: "Indiana",
        IA: "Iowa",
        KS: "Kansas",
        KY: "Kentucky",
        LA: "Louisiana",
        ME: "Maine",
        MD: "Maryland",
        MA: "Massachusetts",
        MI: "Michigan",
        MN: "Minnesota",
        MS: "Mississippi",
        MO: "Missouri",
        MT: "Montana",
        NE: "Nebraska",
        NV: "Nevada",
        NH: "New Hampshire",
        NJ: "New Jersey",
        NM: "New Mexico",
        NY: "New York",
        NC: "North Carolina",
        ND: "North Dakota",
        OH: "Ohio",
        OK: "Oklahoma",
        OR: "Oregon",
        PA: "Pennsylvania",
        RI: "Rhode Island",
        SC: "South Carolina",
        SD: "South Dakota",
        TN: "Tennessee",
        TX: "Texas",
        UT: "Utah",
        VT: "Vermont",
        VA: "Virginia",
        WA: "Washington",
        WV: "West Virginia",
        WI: "Wisconsin",
        WY: "Wyoming",
        DC: "District of Columbia",
    };

    // State name to URL mapping
    const stateUrlMap = {
        Alabama: "alabama",
        Alaska: "alaska",
        Arizona: "arizona",
        Arkansas: "arkansas",
        California: "california",
        Colorado: "colorado",
        Connecticut: "connecticut",
        Delaware: "delaware",
        Florida: "florida",
        Georgia: "georgia",
        Hawaii: "hawaii",
        Idaho: "idaho",
        Illinois: "illinois",
        Indiana: "indiana",
        Iowa: "iowa",
        Kansas: "kansas",
        Kentucky: "kentucky",
        Louisiana: "louisiana",
        Maine: "maine",
        Maryland: "maryland",
        Massachusetts: "massachusetts",
        Michigan: "michigan",
        Minnesota: "minnesota",
        Mississippi: "mississippi",
        Missouri: "missouri",
        Montana: "montana",
        Nebraska: "nebraska",
        Nevada: "nevada",
        "New Hampshire": "new_hampshire", // Changed from new-hampshire
        "New Jersey": "new_jersey", // Already correct
        "New Mexico": "new_mexico", // Already correct
        "New York": "new_york", // Already correct
        "North Carolina": "north_carolina", // Changed from north-carolina
        "North Dakota": "north_dakota", // Changed from north-dakota
        Ohio: "ohio",
        Oklahoma: "oklahoma",
        Oregon: "oregon",
        Pennsylvania: "pennsylvania",
        "Rhode Island": "rhode_island", // Changed from rhode-island
        "South Carolina": "south_carolina", // Changed from south-carolina
        "South Dakota": "south_dakota", // Changed from south-dakota
        Tennessee: "tennessee",
        Texas: "texas",
        Utah: "utah",
        Vermont: "vermont",
        Virginia: "virginia",
        Washington: "washington",
        "West Virginia": "west_virginia", // Changed from west-virginia
        Wisconsin: "wisconsin",
        Wyoming: "wyoming",
        "District of Columbia": "district_of_columbia", // Changed from district-of-columbia
    };

    // Function to get full state name from abbreviation
    function getFullStateName(abbreviation) {
        const upperAbbr = abbreviation.toUpperCase();
        return stateAbbreviationMap[upperAbbr] || abbreviation;
    }

    // Function to handle state clicks
    function loadState(stateName) {
        const urlStateName =
            stateUrlMap[stateName] ||
            stateName.toLowerCase().replace(/\s+/g, "-");
        const url = `/state/medical-billing-services-in-${urlStateName}`;

        showMapLoading();
        window.location.href = url;
    }

    // Show loading overlay
    function showMapLoading() {
        console.log("⏳ Showing map loading...");
        const loadingOverlay = document.getElementById("map-loading");
        if (loadingOverlay) {
            loadingOverlay.style.display = "flex";
        } else {
            console.warn("⚠️ Loading overlay element not found");
        }
    }

    // Hide loading overlay
    function hideMapLoading() {
        console.log("✅ Hiding map loading...");
        const loadingOverlay = document.getElementById("map-loading");
        if (loadingOverlay) {
            loadingOverlay.style.display = "none";
        } else {
            console.warn("⚠️ Loading overlay element not found for hiding");
        }
    }

    // Show tooltip
    function showTooltip(event, stateName) {
        const tooltip = document.getElementById("map-tooltip");
        if (tooltip) {
            tooltip.textContent = `Medical Billing Services in ${stateName}`;
            tooltip.style.left = event.pageX + 10 + "px";
            tooltip.style.top = event.pageY - 40 + "px";
            tooltip.classList.add("show");
        }
    }

    // Hide tooltip
    function hideTooltip() {
        const tooltip = document.getElementById("map-tooltip");
        if (tooltip) {
            tooltip.classList.remove("show");
        }
    }

    // Handle fallback image loading
    function handleFallbackImageLoad() {
        console.log("📸 Fallback image loaded successfully");
        const mapContainer = document.getElementById("usa-map");
        const fallbackImg = document.getElementById("usa-map-fallback");

        if (mapContainer && fallbackImg) {
            // Hide loading and show image
            hideMapLoading();
            fallbackImg.style.display = "block";

            // Add basic click handler for fallback
            fallbackImg.addEventListener("click", function () {
                alert(
                    "Interactive features require JavaScript. Please refresh the page or enable JavaScript for full functionality.",
                );
            });
        }
    }

    // Handle fallback image error
    function handleFallbackImageError() {
        console.error("❌ Fallback image also failed to load");
        hideMapLoading();
        showStateListFallback();
    }

    // Show state list as ultimate fallback
    function showStateListFallback() {
        console.log("📋 Showing state list fallback");
        const mapContainer = document.getElementById("usa-map");
        if (mapContainer) {
            const featuredStates = ["CA", "TX", "FL", "NY", "AL"];
            const stateList = Object.entries(stateAbbreviationMap)
                .map(([abbr, name]) => {
                    const isFeatured = featuredStates.includes(abbr);
                    return `
                        <div class="state-item ${isFeatured ? "featured" : ""}" onclick="loadState('${name}')">
                            <div style="font-weight: bold; margin-bottom: 0.5rem;">${abbr}</div>
                            <div style="font-size: 0.875rem;">${name}</div>
                        </div>
                    `;
                })
                .join("");

            mapContainer.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <h3 style="margin-bottom: 1rem; color: #374151;">Select Your State</h3>
                    <p style="margin-bottom: 2rem; color: #6b7280;">Interactive map unavailable. Click on any state below:</p>
                    <div class="state-list-fallback">
                        ${stateList}
                    </div>
                </div>
            `;
        }
    }

    // Manual test function
    function testMapLoad() {
        console.log("🧪 Manual test triggered");
        const mapContainer = document.getElementById("usa-map");
        if (mapContainer) {
            mapContainer.innerHTML =
                '<div class="map-fallback"><p class="text-gray-500">Testing map load...</p></div>';
            showMapLoading();
            setTimeout(() => {
                initializeMap().catch((error) => {
                    console.error("Manual test failed:", error);
                    showStateListFallback();
                });
            }, 1000);
        }
    }

    // Fetch and initialize SVG map
    async function initializeMap() {
        console.log("🗺️ Starting map initialization...");

        try {
            const mapContainer = document.getElementById("usa-map");
            if (!mapContainer) {
                console.error("❌ Map container not found");
                hideMapLoading();
                return;
            }

            console.log("📦 Map container found, fetching SVG...");

            // Add timeout for fetch
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);

            // Fetch SVG content
            const svgUrl =
                "{{ url_for('static', filename='maps/MapChart_Map.svg') }}";
            console.log("🔗 Fetching from:", svgUrl);

            const response = await fetch(svgUrl, {
                signal: controller.signal,
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                throw new Error(
                    `Failed to fetch SVG: ${response.status} ${response.statusText}`,
                );
            }

            const svgText = await response.text();
            console.log(
                "✅ SVG content fetched successfully, length:",
                svgText.length,
            );
            console.log("📝 SVG content preview:", svgText.substring(0, 200));

            if (!svgText || svgText.length < 100) {
                throw new Error("SVG content appears to be empty or invalid");
            }

            // Validate SVG content
            if (!svgText.includes("<svg") && !svgText.includes("<?xml")) {
                console.error("❌ Content does not appear to be valid SVG");
                throw new Error("Invalid SVG content - missing SVG tags");
            }

            // Inject SVG into container
            mapContainer.innerHTML = svgText;

            // Find the SVG element and make it responsive
            const svgElement = mapContainer.querySelector("svg");
            if (svgElement) {
                svgElement.style.width = "100%";
                svgElement.style.height = "100%";
                svgElement.style.display = "block";
            }

            // Find all state elements
            const states = mapContainer.querySelectorAll("path[id], g[id]");
            const featuredStates = ["CA", "TX", "FL", "NY", "AL"];

            console.log("Found states:", states.length);

            if (states.length === 0) {
                console.warn("No state elements found in SVG");
                return;
            }

            // Process each state element
            states.forEach((state) => {
                const stateId = state.id;

                // Skip if no ID or invalid ID
                if (!stateId || stateId.length < 2) {
                    return;
                }

                // Extract state abbreviation from various ID formats
                let stateAbbr = "";

                // Handle different ID formats: "CA", "MN_S", "OH_E", "california", etc.
                if (stateId.includes("_")) {
                    stateAbbr = stateId.split("_")[0].toUpperCase();
                } else if (stateId.length === 2) {
                    stateAbbr = stateId.toUpperCase();
                } else {
                    // Try to match full state names or find abbreviation
                    const idUpper = stateId.toUpperCase();
                    for (const [abbr, fullName] of Object.entries(
                        stateAbbreviationMap,
                    )) {
                        if (
                            idUpper.includes(abbr) ||
                            idUpper.includes(
                                fullName.toUpperCase().replace(/\s+/g, ""),
                            )
                        ) {
                            stateAbbr = abbr;
                            break;
                        }
                    }
                }

                // Validate state abbreviation
                if (!stateAbbr || !stateAbbreviationMap[stateAbbr]) {
                    console.log(
                        "Skipping element with invalid state:",
                        stateId,
                    );
                    return;
                }

                const fullStateName = stateAbbreviationMap[stateAbbr];
                console.log(
                    `Processing: ${stateId} -> ${stateAbbr} -> ${fullStateName}`,
                );

                // Set initial styles - make element visible and interactive
                state.style.display = "block";
                state.style.visibility = "visible";
                state.style.fill = "#e5e7eb";
                state.style.stroke = "#ffffff";
                state.style.strokeWidth = "1";
                state.style.cursor = "pointer";
                state.style.transition = "all 0.3s ease";
                state.style.pointerEvents = "all";

                // Mark featured states
                if (featuredStates.includes(stateAbbr)) {
                    state.classList.add("featured");
                    state.style.fill = "#f59e0b";
                    state.style.strokeWidth = "1.5";
                }

                // Add click handler
                state.addEventListener("click", function (e) {
                    console.log("State clicked:", stateId, "->", fullStateName);
                    e.preventDefault();
                    e.stopPropagation();

                    // Reset all states
                    states.forEach((s) => {
                        s.classList.remove("active");
                        const sId = s.id;
                        let sAbbr = "";
                        if (sId.includes("_")) {
                            sAbbr = sId.split("_")[0].toUpperCase();
                        } else if (sId.length === 2) {
                            sAbbr = sId.toUpperCase();
                        }

                        if (featuredStates.includes(sAbbr)) {
                            s.style.fill = "#f59e0b";
                            s.style.strokeWidth = "1.5";
                        } else {
                            s.style.fill = "#e5e7eb";
                            s.style.strokeWidth = "1";
                        }
                        s.style.filter = "none";
                    });

                    // Highlight clicked state
                    this.classList.add("active");
                    this.style.fill = "#065f46";
                    this.style.strokeWidth = "2";
                    this.style.filter =
                        "drop-shadow(0 4px 12px rgba(6, 95, 70, 0.5))";

                    // Navigate to state page
                    loadState(fullStateName);
                });

                // Add hover handlers
                state.addEventListener("mouseenter", function (e) {
                    if (!this.classList.contains("active")) {
                        if (this.classList.contains("featured")) {
                            this.style.fill = "#d97706";
                            this.style.filter =
                                "drop-shadow(0 4px 8px rgba(245, 158, 11, 0.4))";
                        } else {
                            this.style.fill = "#008ba3";
                            this.style.filter =
                                "drop-shadow(0 4px 8px rgba(0, 139, 163, 0.3))";
                        }
                        this.style.strokeWidth = "2";
                        showTooltip(e, fullStateName);
                    }
                });

                state.addEventListener("mouseleave", function () {
                    if (!this.classList.contains("active")) {
                        if (this.classList.contains("featured")) {
                            this.style.fill = "#f59e0b";
                            this.style.strokeWidth = "1.5";
                        } else {
                            this.style.fill = "#e5e7eb";
                            this.style.strokeWidth = "1";
                        }
                        this.style.filter = "none";
                    }
                    hideTooltip();
                });

                state.addEventListener("mousemove", function (e) {
                    if (!this.classList.contains("active")) {
                        showTooltip(e, fullStateName);
                    }
                });

                // Accessibility
                state.setAttribute("tabindex", "0");
                state.setAttribute("role", "button");
                state.setAttribute(
                    "aria-label",
                    `Click to view Medical Billing Services in ${fullStateName}`,
                );

                state.addEventListener("keydown", function (e) {
                    if (e.key === "Enter" || e.key === " ") {
                        e.preventDefault();
                        loadState(fullStateName);
                    }
                });
            });

            hideMapLoading();
            console.log(
                "Map initialized successfully with",
                states.length,
                "interactive states",
            );
        } catch (error) {
            console.error("❌ Error initializing map:", error);
            console.log("🔄 Attempting fallback image method...");

            // Try fallback image method
            const fallbackImg = document.getElementById("usa-map-fallback");
            if (fallbackImg) {
                // Force trigger fallback image load
                fallbackImg.style.display = "block";

                // If image is already loaded
                if (fallbackImg.complete) {
                    handleFallbackImageLoad();
                } else {
                    // Wait for image to load or error
                    setTimeout(() => {
                        if (!fallbackImg.complete) {
                            handleFallbackImageError();
                        }
                    }, 5000);
                }
            } else {
                hideMapLoading();
                // Show state list fallback as final option
                showStateListFallback();
            }
        }
    }

    // Handle browser navigation and initialization
    function handlePageNavigation() {
        console.log("🚀 Handling page navigation...");
        showMapLoading();

        // Add safety timeout
        const safetyTimeout = setTimeout(() => {
            console.warn("⚠️ Map initialization timeout reached");
            hideMapLoading();
        }, 15000);

        // Initialize immediately
        initializeMap().finally(() => {
            clearTimeout(safetyTimeout);
        });
    }

    // Initialize map on page load with multiple triggers
    document.addEventListener("DOMContentLoaded", function () {
        console.log("📄 DOM Content Loaded");
        handlePageNavigation();
    });

    // Backup initialization for faster loading
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", handlePageNavigation);
    } else {
        console.log("📄 DOM already ready, initializing immediately");
        handlePageNavigation();
    }

    // Handle back/forward navigation
    window.addEventListener("pageshow", function (event) {
        console.log("👀 Page show event", { persisted: event.persisted });
        if (event.persisted) {
            handlePageNavigation();
        }
    });

    // Handle visibility change (when tab becomes visible again)
    document.addEventListener("visibilitychange", function () {
        if (!document.hidden) {
            console.log("👁️ Page became visible");
            const mapContainer = document.getElementById("usa-map");
            if (mapContainer && !mapContainer.querySelector("svg")) {
                console.log("🔄 Re-initializing map after visibility change");
                handlePageNavigation();
            }
        }
    });
</script>

<style>
    /* ===== MAP CONTAINER STYLES ===== */
    .map-container-fixed {
        position: relative;
        width: 100%;
        height: 900px;
        overflow: hidden;
        background: #f8f9fa;
        border-radius: 12px;
    }

    .usa-map-container {
        width: 100%;
        height: 100%;
        display: block;
    }

    .usa-map-container svg {
        width: 100%;
        height: 100%;
        display: block;
    }

    .map-fallback {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        background: #f3f4f6;
        color: #6b7280;
    }

    /* ===== LOADING OVERLAY STYLES ===== */
    .map-loading {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        border-radius: 12px;
    }

    .loading-spinner {
        text-align: center;
    }

    .spinner {
        border: 4px solid #e5e7eb;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* ===== TOOLTIP STYLES ===== */
    .map-tooltip {
        position: absolute;
        backdrop-filter: blur(10px);
        background: rgba(13, 148, 136, 0.85);
        color: #077fff;
        padding: 10px 16px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        white-space: nowrap;
        pointer-events: none;
        opacity: 0;
        transform: scale(0.95);
        transition:
            opacity 0.3s ease,
            transform 0.3s ease;
        z-index: 1000;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .map-tooltip.show {
        opacity: 1;
        transform: scale(1);
    }

    .map-tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 20px;
        transform: translateX(0);
        border: 6px solid transparent;
        border-top-color: rgba(13, 148, 136, 0.85);
    }

    .state {
        fill: #e5e7eb;
        stroke: #ffffff;
        stroke-width: 1;
        cursor: pointer;
        transition:
            fill 0.3s ease,
            stroke-width 0.3s ease;
    }

    .state:hover {
        fill: #008ba3;
        stroke-width: 2;
        filter: drop-shadow(0 4px 8px rgba(0, 139, 163, 0.3));
    }

    /* ===== RESPONSIVE DESIGN ===== */
    @media (max-width: 768px) {
        .map-container-fixed {
            height: 350px;
        }

        .grid.lg\\:grid-cols-3 {
            grid-template-columns: 1fr;
        }

        .grid.md\\:grid-cols-3 {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
    }

    @media (max-width: 480px) {
        .map-container-fixed {
            height: 300px;
            margin: 0 -1rem;
            border-radius: 0;
        }
    }

    /* ===== MAP STATE INTERACTION STYLES ===== */
    .usa-map-container svg path,
    .usa-map-container svg g {
        cursor: pointer;
        transition: all 0.3s ease;
        stroke: #ffffff;
    }

    .usa-map-container svg path:focus,
    .usa-map-container svg g:focus {
        outline: 2px solid #008ba3;
        outline-offset: 2px;
    }

    /* Ensure all state elements are properly styled */
    .usa-map-container svg [id],
    .usa-map-container svg .state {
        cursor: pointer;
        transition: all 0.3s ease;
        stroke: #ffffff;
    }

    /* ===== CUSTOM SCROLLBAR ===== */
    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    /* ===== FALLBACK STATE LIST ===== */
    .state-list-fallback {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        padding: 2rem;
    }

    .state-item {
        background: #f3f4f6;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .state-item:hover {
        background: #008ba3;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 139, 163, 0.3);
    }

    .state-item.featured {
        background: #f59e0b;
        color: white;
        border-color: #d97706;
    }

    .state-item.featured:hover {
        background: #d97706;
    }
</style>
{% endblock %}
