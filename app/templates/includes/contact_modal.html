<!-- Contact Modal -->
<div id="contactModal" class="fixed inset-0 z-50 hidden overflow-y-auto font-montserrat rounded-md" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-center justify-center min-h-screen px-4 py-8 text-center sm:block sm:p-0 ">
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-black bg-opacity-60 transition-opacity" aria-hidden="true" id="modalOverlay"></div>

    <!-- Centering trick -->
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

    <!-- Modal panel -->
    <div class="inline-block align-middle bg-white rounded-md shadow-xl transform transition-all sm:max-w-xl w-full">
      <div class="bg-white px-6 py-6">
        <div class="grid sm:grid-cols-[auto,1fr] gap-4 items-start">
          <div class="flex-shrink-0 h-12 w-12 rounded-full bg-brand-secondary flex items-center justify-center">
            <i class="ri-mail-send-line text-brand-primary text-xl"></i>
          </div>
          <div>
            <h3 class="text-xl font-semibold text-gray-900 mb-1" id="modal-title">Get Expert Healthcare Solutions</h3>
            <p class="text-sm text-gray-500 leading-relaxed">Ready to streamline your revenue cycle? Letâ€™s discuss how Ardur Healthcare can help your practice thrive.</p>
          </div>
        </div>

        <!-- Contact Form -->
        <form id="modalContactForm" class="mt-6 space-y-4" action="{{ url_for('contact.contact_form') }}" method="POST">
          {% set form = contact_form if contact_form is defined else {} %}
          {% if form.hidden_tag is defined %} {{ form.hidden_tag() }} {% else %}
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}" /> {% endif %}

          <input type="text" name="name" id="modal_name" placeholder="Your Name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary focus:outline-none" />

          <input type="email" name="email" id="modal_email" placeholder="Your Email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary focus:outline-none" />

          <div class="flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0">
            <select name="phone_country_code" id="modal_phone_country_code" class="w-full sm:w-1/3 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary focus:outline-none">
              <option value="+1">+1 (US)</option>
              <option value="+91">+91 (India)</option>
              <option value="+44">+44 (UK)</option>
              <option value="+61">+61 (Australia)</option>
              <option value="+971">+971 (UAE)</option>
            </select>
            <input type="tel" name="phone_number" id="modal_phone_number" placeholder="Phone Number" required class="w-full flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary focus:outline-none" />
          </div>

          <input type="text" name="practice" id="modal_practice" placeholder="Practice Name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary focus:outline-none" />

          <input type="text" name="state" id="modal_state" placeholder="State" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary focus:outline-none" />

          <select name="service_type" id="modal_service_type" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary focus:outline-none">
            <option value="">Select service type</option>
            <option value="medical-billing">Medical Billing</option>
            <option value="coding-services">Coding Services</option>
            <option value="credentialing">Provider Credentialing</option>
            <option value="ar-management">AR Management</option>
            <option value="denial-management">Denial Management</option>
            <option value="full-service">Full Service Package</option>
            <option value="consultation">Consultation</option>
          </select>

          <input type="hidden" name="specialties" id="modal_specialties" value="General Practice" />

          <textarea name="message" id="modal_message" rows="3" placeholder="Tell us about your needs..." required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-primary focus:outline-none resize-none"></textarea>

          <div class="flex items-start">
            <input type="checkbox" name="privacy_policy_agreement" id="modal_privacy_policy" required class="h-4 w-4 text-brand-primary focus:ring-brand-primary border-gray-300 rounded mt-1" />
            <label for="modal_privacy_policy" class="ml-2 text-sm text-gray-700">
              I agree to the
              <a href="{{ url_for('main.privacy_policy') }}" class="text-brand-primary hover:underline" target="_blank">Privacy Policy</a>
            </label>
          </div>
        </form>
      </div>

      <!-- Modal footer -->
      <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3">
        <button type="submit" form="modalContactForm" class="px-5 py-2 rounded-lg bg-brand-primary text-white hover:bg-brand-accent font-medium transition duration-150">
          Send Message
        </button>
        <button type="button" id="closeModalBtn" class="px-5 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 font-medium transition duration-150">
          Maybe Later
        </button>
      </div>
    </div>
  </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById("contactModal");
        const overlay = document.getElementById("modalOverlay");
        const closeBtn = document.getElementById("closeModalBtn");
        const form = document.getElementById("modalContactForm");

        let modalShown = false;
        let modalClosed = false;
        let initialTimeout = null;
        let secondTimeout = null;

        // Function to show modal
        function showModal() {
            if (!modalShown && !modalClosed && !sessionStorage.getItem("contactFormSubmitted")) {
                modal.classList.remove("hidden");
                modalShown = true;
                sessionStorage.setItem("contactModalShown", "true");

                // Add fade-in animation
                setTimeout(() => {
                    modal
                        .querySelector(".bg-gray-500")
                        .classList.add("opacity-75");
                    modal
                        .querySelector(".inline-block")
                        .classList.add("opacity-100", "translate-y-0");
                }, 10);
            }
        }

        // Function to hide modal
        function hideModal() {
            modal.classList.add("hidden");
            modalClosed = true;

            // Clear any existing timeouts
            if (initialTimeout) {
                clearTimeout(initialTimeout);
            }
            if (secondTimeout) {
                clearTimeout(secondTimeout);
            }

            // Set timer for second popup (40 seconds after closing)
            secondTimeout = setTimeout(() => {
                if (
                    modalClosed &&
                    !document.getElementById("modalContactForm").dataset
                        .submitted
                ) {
                    modalClosed = false;
                    showModal();
                }
            }, 40000); // 40 seconds
        }

        // Show modal after exactly 15 seconds if not already shown
        if (!modalShown && !sessionStorage.getItem("contactFormSubmitted")) {
            initialTimeout = setTimeout(() => {
                showModal();
            }, 15000); // Exactly 15 seconds
        }

        // Close modal event listeners
        closeBtn.addEventListener("click", hideModal);
        overlay.addEventListener("click", hideModal);

        // Close on Escape key
        document.addEventListener("keydown", function (e) {
            if (e.key === "Escape" && !modal.classList.contains("hidden")) {
                hideModal();
            }
        });

        // Handle form submission
        form.addEventListener("submit", function (e) {
            e.preventDefault();

            // Mark form as submitted to prevent future popups
            form.dataset.submitted = "true";
            sessionStorage.setItem("contactFormSubmitted", "true");

            // Clear timeouts
            if (initialTimeout) clearTimeout(initialTimeout);
            if (secondTimeout) clearTimeout(secondTimeout);

            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = "Sending...";
            submitBtn.disabled = true;

            // Create FormData and submit via fetch
            const formData = new FormData(form);

            fetch(form.action, {
                method: "POST",
                body: formData,
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        // Show success message
                        modal.querySelector(".bg-white").innerHTML = `
                    <div class="p-6 text-center">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                            <i class="ri-check-line text-green-600 text-xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Thank You!</h3>
                        <p class="text-sm text-gray-500 mb-4">Your message has been sent successfully. We'll get back to you soon!</p>
                        <button onclick="document.getElementById('contactModal').classList.add('hidden')"
                                class="inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-brand-primary text-base font-medium text-white hover:bg-brand-accent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-primary">
                            Close
                        </button>
                    </div>
                `;

                        // Auto-close after 3 seconds
                        setTimeout(() => {
                            hideModal();
                        }, 3000);
                    } else {
                        // Show error message
                        alert(
                            "There was an error sending your message. Please try again.",
                        );
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert(
                        "There was an error sending your message. Please try again.",
                    );
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                });
        });

        // Don't show modal if form was already submitted in this session
        if (sessionStorage.getItem("contactFormSubmitted")) {
            if (initialTimeout) clearTimeout(initialTimeout);
            if (secondTimeout) clearTimeout(secondTimeout);
        }
    });
</script>